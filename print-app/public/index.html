<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Editor de Fotos (V1.03 - Corregido)</title>
    
    <style>
        /* CSS (Exactamente igual que antes ok todo fino) */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #333;
            color: white;
        }
        #editor-area {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        #addPhotoBtn {
            width: 40px;
            height: 40px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #5a95f5;
            border: none;
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #addPhotoBtn svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }
        .image-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            touch-action: none;
            user-select: none;
            border: 2px dashed #5a95f5;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.5);
        }
        .image-wrapper img {
            display: block;
            width: 150px;
            height: auto;
            pointer-events: none;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
</head>
<body>

    <main id="editor-area">
        <div style="text-align: center; padding-top: 50px; color: #999;">V1.04 Toca el clip para añadir fotos </div>
    </main>

    <button id="addPhotoBtn" aria-label="Agregar fotos">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
        </svg>
    </button>

    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">


    <script>
        // Referencias del DOM (Igual que antes)
        const addButton = document.getElementById('addPhotoBtn');
        const fileInput = document.getElementById('fileInput');
        const editorArea = document.getElementById('editor-area');
        let imageCount = 0;
        const MAX_IMAGES = 10;

        // Conexión del botón (Igual que antes)
        addButton.addEventListener('click', () => {
            fileInput.click();
        });

        // Manejo de carga de archivos (Igual que antes)
        fileInput.addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            if (imageCount + files.length > MAX_IMAGES) {
                alert(`Puedes subir un máximo de ${MAX_IMAGES} fotos. Ya tienes ${imageCount}.`);
                return;
            }
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                const reader = new FileReader();
                reader.onload = (e) => {
                    createImageEditor(e.target.result); // Llama a la función actualizada
                    imageCount++;
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = null;
        }

        
        // --- PASO 3: FUNCIÓN DE EDICIÓN (ACTUALIZADA V1.03) ---
        
        function createImageEditor(imageUrl) {
            // 1. Crear los elementos HTML (sin cambios)
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            
            wrapper.appendChild(img);
            editorArea.appendChild(wrapper);

            // 2. Definir el "ESTADO" independiente (sin cambios)
            // 'current' es el estado visual actual y persistente.
            let currentScale = 1;
            let currentRotation = 0;
            let currentX = 0; 
            let currentY = 0;
            
            // 'last' solo guardará el estado al INICIO de un gesto.
            let lastScale = 1;
            let lastRotation = 0;
            let lastX = 0;
            let lastY = 0;

            // 3. Inicializar Hammer.js (sin cambios)
            const hammer = new Hammer(wrapper);
            hammer.get('pan').set({ direction: Hammer.DIRECTION_ALL });
            hammer.get('pinch').set({ enable: true });
            hammer.get('rotate').set({ enable: true });

            
            // --- 4. Asignar eventos de gestos ---

            // Esta función "ancla" el estado actual. Se llama al inicio de CUALQUIER gesto.
            // (Sin cambios, esta función es correcta)
            function syncStartState() {
                wrapper.style.zIndex = 100; // Poner al frente
                
                // Copia el estado VISIBLE actual al estado 'last' (ancla)
                lastScale = currentScale;
                lastRotation = currentRotation;
                lastX = currentX;
                lastY = currentY;
            }

            // Asignamos la misma función a TODOS los eventos "start"
            // (Sin cambios)
            hammer.on('panstart', syncStartState);
            hammer.on('pinchstart', syncStartState);
            hammer.on('rotatestart', syncStartState);

            // ARRASTRAR (Mover)
            // (Sin cambios)
            hammer.on('pan', (ev) => {
                // El nuevo 'current' se basa en el 'last' + delta
                currentX = lastX + ev.deltaX;
                currentY = lastY + ev.deltaY;
                applyTransform();
            });

            // PELLIZCAR (Tamaño/Zoom)
            // (Sin cambios)
            hammer.on('pinch', (ev) => {
                currentScale = lastScale * ev.scale;
                applyTransform();
            });

            // ROTAR (Orientación)
            // (Sin cambios)
            hammer.on('rotate', (ev) => {
                currentRotation = lastRotation + ev.rotation;
                applyTransform();
            });

            // --- ¡AQUÍ ESTÁ LA CORRECCIÓN! ---
            // Detectar el final del gesto
            hammer.on('hammer.input', (ev) => {
                if (ev.isFinal) {
                    // Al soltar, solo devolvemos el z-index a la normalidad.
                    wrapper.style.zIndex = 10; 
                    
                    // ¡YA NO guardamos el estado aquí!
                    // Las variables 'current...' YA tienen el valor final correcto.
                    // 'last...' solo se actualizará la próxima vez que
                    // el usuario toque la imagen (en syncStartState).
                }
            });

            // 5. Función que aplica todos los cambios (sin cambios)
            function applyTransform() {
                wrapper.style.transform = 
                    `translate3d(${currentX}px, ${currentY}px, 0) ` +
                    `scale(${currentScale}) ` +
                    `rotate(${currentRotation}deg)`;
            }
            
            // Aplicar la transformación inicial (sin cambios)
            applyTransform();
        }

    </script>
</body>
</html>