<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Editor de Fotos (Corregido) <V1 class="3"></V1></title>
    
    <style>
        /* CSS (Exactamente igual que antes ok todo fino) */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #333;
            color: white;
        }
        #editor-area {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #f0f0f0;
            overflow: hidden;
        }
        #addPhotoBtn {
            width: 40px;
            height: 40px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #5a95f5;
            border: none;
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #addPhotoBtn svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }
        .image-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            touch-action: none;
            user-select: none;
            border: 2px dashed #5a95f5;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.5);
        }
        .image-wrapper img {
            display: block;
            width: 150px;
            height: auto;
            pointer-events: none;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
</head>
<body>

    <main id="editor-area">
        <div style="text-align: center; padding-top: 50px; color: #999;">Toca el clip para añadir fotos</div>
    </main>

    <button id="addPhotoBtn" aria-label="Agregar fotos">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
        </svg>
    </button>

    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">


    <script>
        // Referencias del DOM (Igual que antes)
        const addButton = document.getElementById('addPhotoBtn');
        const fileInput = document.getElementById('fileInput');
        const editorArea = document.getElementById('editor-area');
        let imageCount = 0;
        const MAX_IMAGES = 10;

        // Conexión del botón (Igual que antes)
        addButton.addEventListener('click', () => {
            fileInput.click();
        });

        // Manejo de carga de archivos (Igual que antes)
        fileInput.addEventListener('change', handleImageUpload);

        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            if (imageCount + files.length > MAX_IMAGES) {
                alert(`Puedes subir un máximo de ${MAX_IMAGES} fotos. Ya tienes ${imageCount}.`);
                return;
            }
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                const reader = new FileReader();
                reader.onload = (e) => {
                    createImageEditor(e.target.result); // Llama a la función actualizada
                    imageCount++;
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = null;
        }

        // --- PASO 3: FUNCIÓN DE EDICIÓN (ACTUALIZADA) ---
        
        function createImageEditor(imageUrl) {
            // 1. Crear elementos (Igual que antes)
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';
            const img = document.createElement('img');
            img.src = imageUrl;
            wrapper.appendChild(img);
            editorArea.appendChild(wrapper);

            // 2. "ESTADO" independiente de esta imagen
            // 'current' = el valor "en vivo" mientras se transforma
            let currentScale = 1;
            let currentRotation = 0;
            let currentX = 0;
            let currentY = 0;
            
            // 'last' = el valor "ancla" que se guarda al INICIAR un gesto
            let lastScale = 1;
            let lastRotation = 0;
            let lastX = 0;
            let lastY = 0;

            // 3. Inicializar Hammer.js
            const hammer = new Hammer(wrapper);

            // Habilitar gestos
            hammer.get('pan').set({ direction: Hammer.DIRECTION_ALL });
            hammer.get('pinch').set({ enable: true });
            hammer.get('rotate').set({ enable: true });

            // --- CAMBIO CLAVE (1): Reconocer gestos simultáneos ---
            // Esto permite que "pan" (mover) funcione AL MISMO TIEMPO
            // que "pinch" (escalar) y "rotate" (rotar).
            hammer.get('pinch').recognizeWith(hammer.get('rotate'));
            hammer.get('pan').recognizeWith([hammer.get('pinch'), hammer.get('rotate')]);


            // --- CAMBIO CLAVE (2): Guardar el estado al INICIAR el toque ---
            // 'hammer.input' es el evento más básico.
            // 'ev.isFirst' es true solo en el primer fotograma del primer toque.
            hammer.on('hammer.input', (ev) => {
                if (ev.isFirst) {
                    // Guardamos el estado ACTUAL como nuestro "ancla" (last)
                    lastScale = currentScale;
                    lastRotation = currentRotation;
                    lastX = currentX;
                    lastY = currentY;
                }
            });
            
            // Poner la imagen al frente cuando se toca
            hammer.on('panstart pinchstart rotatestart', () => {
                wrapper.style.zIndex = 100;
            });
            
            // Devolverla a su z-index normal al soltar
            hammer.on('panend pinchend rotateend', () => {
                 wrapper.style.zIndex = 10;
            });


            // --- 4. Asignar eventos de gestos (Lógica actualizada) ---

            // ARRASTRAR (Mover)
            hammer.on('pan', (ev) => {
                // Calculamos el nuevo 'current' basado en el 'last' + el cambio (delta)
                currentX = lastX + ev.deltaX;
                currentY = lastY + ev.deltaY;
                applyTransform();
            });

            // PELLIZCAR (Tamaño/Zoom)
            hammer.on('pinch', (ev) => {
                // Calculamos la nueva escala basada en la 'last' * el multiplicador
                currentScale = lastScale * ev.scale;
                applyTransform();
            });

            // ROTAR (Orientación)
            hammer.on('rotate', (ev) => {
                // Calculamos la nueva rotación basada en la 'last' + los grados rotados
                currentRotation = lastRotation + ev.rotation;
                applyTransform();
            });

            // 5. Función que aplica todos los cambios
            function applyTransform() {
                // Aplicamos los valores "current" al CSS
                wrapper.style.transform = 
                    `translate3d(${currentX}px, ${currentY}px, 0) ` +
                    `scale(${currentScale}) ` +
                    `rotate(${currentRotation}deg)`;
            }
            
            // Aplicar la transformación inicial (centrado)
            applyTransform();
        }

    </script>
</body>
</html>